#!/bin/sh

RUNIT_DIR="$HOME/.runit/runsvdir"

cleanup() {
    echo "Cerrando servicios runit del usuario $USER"

    # Baja servicios primero (limpio)
    sv -w 5 -v down "$RUNIT_DIR"/* 2>/dev/null

    # Mata runsv del usuario
    pkill -TERM -u "$USER" runsv 2>/dev/null
    pkill -TERM -u "$USER" runsvdir 2>/dev/null

    # Por si alguno queda colgado
    sleep 1
    pkill -KILL -u "$USER" runsv 2>/dev/null
    pkill -KILL -u "$USER" runsvdir 2>/dev/null
}

trap cleanup EXIT INT TERM HUP

# Arranca runsvdir normalmente
runsvdir "$RUNIT_DIR" &
RUNIT_PID=$!

# Espera a que termine
wait "$RUNIT_PID"
